# Database Setup Guide - StatPatternHub

## Overview

This guide walks you through setting up Vercel Postgres (powered by Neon) for StatPatternHub's Phase 2 implementation.

**What you'll achieve:**
- ‚úÖ Vercel Postgres database (free tier - 0.5GB storage, 100 compute-hours/month)
- ‚úÖ Local development connected to Vercel database
- ‚úÖ Type-safe queries with Drizzle ORM
- ‚úÖ Database schema for patterns and users (3 tables)

---

## Prerequisites

- ‚úÖ Vercel account (free tier)
- ‚úÖ StatPatternHub project deployed on Vercel
- ‚úÖ Node.js installed locally
- ‚úÖ Vercel CLI installed (`npm install -g vercel`)

---

## Step 1: Create Database on Vercel Dashboard

1. **Go to Vercel Dashboard**: https://vercel.com/dashboard
2. **Select your project**: Click on `sp-skill`
3. **Navigate to Storage tab**
4. **Click "Create Database"**
5. **Select "Neon"** from Marketplace Database Providers (Serverless Postgres)
6. **Configure database**:
   - **Name**: `statpatternhub-db` (or your preference)
   - **Region**: Choose closest to your users (e.g., `us-east-1`)
   - **Plan**: Neon Free (automatically selected)
7. **Click "Create"**
8. **Connect to project**: Select `sp-skill` when prompted

Vercel will automatically add these environment variables to your project:
- `POSTGRES_URL` - Main connection string (with pooling) - **Use this for API calls**
- `POSTGRES_PRISMA_URL` - Optimized for Prisma ORM
- `POSTGRES_URL_NON_POOLING` - Direct connection (use only for migrations)
- `POSTGRES_USER`, `POSTGRES_HOST`, `POSTGRES_PASSWORD`, `POSTGRES_DATABASE`

---

## Step 2: Set Up Local Development

### 2.1 Install Vercel CLI

```bash
npm install -g vercel
```

### 2.2 Login to Vercel

```bash
vercel login
```

This will open a browser for authentication.

### 2.3 Link Your Local Project

**Important**: Your project path must NOT contain spaces. If it does, move it first:

```powershell
# ‚ùå Bad: C:\Users\name\My Web Sites\sp-skill
# ‚úÖ Good: C:\Users\name\Documents\sp-skill

# Windows: Move project if needed
Move-Item "C:\path\with spaces\sp-skill" "C:\path\without\spaces\sp-skill"
cd C:\path\without\spaces\sp-skill
```

Then link:

```bash
vercel link
```

When prompted:
- **Scope**: Select your Vercel account
- **Link to existing project?**: Yes
- **Project name**: `sp-skill`

### 2.4 Pull Environment Variables

```bash
vercel env pull .env.local
```

This creates a `.env.local` file with your database credentials:

```env
# .env.local (auto-generated by Vercel)
POSTGRES_URL="postgres://username:password@host/database?sslmode=require"
POSTGRES_PRISMA_URL="postgres://username:password@host/database?sslmode=require&pgbouncer=true"
POSTGRES_URL_NON_POOLING="postgres://username:password@host/database?sslmode=require"
POSTGRES_USER="username"
POSTGRES_HOST="host.region.neon.tech"
POSTGRES_PASSWORD="password"
POSTGRES_DATABASE="database_name"

# Your existing API key (add manually if missing)
GEMINI_API_KEY=your_api_key_here
```

**Important**: `.env.local` is in `.gitignore` - never commit it to git!

---

## Step 3: Run Development Servers

StatPatternHub requires **two separate servers** running simultaneously:

### Terminal 1: Frontend (Vite)

```bash
npm run dev
```

This starts Vite on **port 3000** and proxies `/api/*` requests to port 3001.

Expected output:
```
VITE v6.x.x  ready in xxx ms
‚ûú  Local:   http://localhost:3000/
```

### Terminal 2: API (Vercel Serverless Functions)

```bash
npm run dev:api
```

This starts Vercel dev server on **port 3001** to execute serverless functions.

Expected output:
```
Ready! Available at http://localhost:3001
```

**Keep both terminals running** during development.

---

## Step 4: Test Database Connection

### Option A: Browser

Open your browser and navigate to:
```
http://localhost:3000/api/db-test
```

### Option B: Command Line

**Windows PowerShell:**
```powershell
Invoke-RestMethod -Uri http://localhost:3000/api/db-test
```

**macOS/Linux/Git Bash:**
```bash
curl http://localhost:3000/api/db-test
```

### Expected Response

```json
{
  "connected": true,
  "timestamp": "2025-12-25T21:11:10.894Z",
  "dbVersion": "PostgreSQL 17.7 on aarch64-unknown-linux-gnu...",
  "environment": {
    "POSTGRES_URL": true,
    "POSTGRES_HOST": true,
    "POSTGRES_USER": true,
    "POSTGRES_DATABASE": true
  },
  "message": "Database connection successful!"
}
```

‚úÖ If you see `"connected": true`, your setup is working!

---

## Step 5: Run Database Migration

### 5.1 Add Migration Token

Add this line to your `.env.local` file:

```env
MIGRATION_TOKEN=my-secret-key-12345
```

Choose any random string for the token (e.g., use a password generator).

**Location**:
- Windows: `C:\Users\yourname\Documents\sp-skill\.env.local`
- macOS/Linux: `~/sp-skill/.env.local`

### 5.2 Restart API Server (Terminal 2)

Environment variables are loaded only at startup, so restart:

```bash
# Press Ctrl+C to stop
npm run dev:api
```

Wait for: `Ready! Available at http://localhost:3001`

### 5.3 Run Migration

**Windows PowerShell:**
```powershell
Invoke-RestMethod -Uri http://localhost:3000/api/migrate `
  -Method POST `
  -Headers @{"x-migration-token"="my-secret-key-12345"}
```

**macOS/Linux/Git Bash:**
```bash
curl -X POST http://localhost:3000/api/migrate \
  -H "x-migration-token: my-secret-key-12345"
```

### Expected Response

```json
{
  "success": true,
  "message": "Database tables created successfully",
  "timestamp": "2025-12-25T21:15:00.000Z"
}
```

This creates the following tables:
- `users` - User profiles and roles
- `pattern_definitions` - Pattern metadata (immutable)
- `pattern_implementations` - Code implementations (mutable)

---

## Step 6: Verify Tables Were Created

### Option A: API Endpoint (Easiest)

```
http://localhost:3000/api/list-tables
```

Expected response:
```json
{
  "success": true,
  "count": 3,
  "tables": [
    "pattern_definitions",
    "pattern_implementations",
    "users"
  ],
  "message": "Found 3 table(s)"
}
```

### Option B: Neon Console (GUI)

1. Go to Vercel Dashboard ‚Üí Storage ‚Üí Your database
2. Click **"Open in Neon"** button
3. In Neon console, navigate to **Tables** in the left sidebar
4. You'll see all 3 tables with their schemas

---

## Database Schema Overview

### Tables Created

#### 1. **users**
```sql
id SERIAL PRIMARY KEY
email VARCHAR(255) UNIQUE NOT NULL
name VARCHAR(255)
role VARCHAR(50) DEFAULT 'guest'  -- guest, contributor, premier, admin
created_at TIMESTAMP
updated_at TIMESTAMP
```

**Default data**: System user (id: 1, email: system@statpatternhub.com)

#### 2. **pattern_definitions** (Immutable Container)
```sql
id VARCHAR(20) PRIMARY KEY           -- e.g., 'IMP-001'
category VARCHAR(10) NOT NULL        -- e.g., 'IMP', 'DER'
title VARCHAR(255) NOT NULL
problem TEXT NOT NULL
when_to_use TEXT NOT NULL
created_at TIMESTAMP
```

**Purpose**: Defines WHAT the pattern solves (problem, when to use)

#### 3. **pattern_implementations** (Mutable Content)
```sql
uuid UUID PRIMARY KEY
pattern_id VARCHAR(20) REFERENCES pattern_definitions(id)
author_id INTEGER REFERENCES users(id)
author_name VARCHAR(255) NOT NULL
sas_code TEXT
r_code TEXT
considerations TEXT[]                -- Array of strings
variations TEXT[]                    -- Array of strings
status VARCHAR(20) DEFAULT 'pending' -- active, pending, rejected
is_premium BOOLEAN DEFAULT FALSE
created_at TIMESTAMP
updated_at TIMESTAMP
```

**Purpose**: Contains HOW to implement the pattern (code, considerations)

---

## Available API Endpoints

| Endpoint | Method | Description | Auth Required |
|----------|--------|-------------|---------------|
| `/api/db-test` | GET | Test database connection | No |
| `/api/list-tables` | GET | List all database tables | No |
| `/api/migrate` | POST | Create database schema | Token in header |
| `/api/analyze` | POST | Gemini AI extraction (existing) | No |

---

## Using the Database in Your Code

### Example 1: Query with Drizzle ORM (Type-Safe)

```typescript
import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../db';
import { patternDefinitions } from '../db/schema';
import { eq } from 'drizzle-orm';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // Type-safe query with autocomplete
  const patterns = await db
    .select()
    .from(patternDefinitions)
    .where(eq(patternDefinitions.category, 'IMP'));

  return res.json({ patterns });
}
```

### Example 2: Raw SQL Query

```typescript
import { sql } from '@vercel/postgres';

export default async function handler(req, res) {
  // Parameterized query (prevents SQL injection)
  const result = await sql`
    SELECT * FROM pattern_definitions
    WHERE category = ${category}
    LIMIT 10
  `;

  return res.json({ patterns: result.rows });
}
```

### Example 3: Insert Data

```typescript
import { db } from '../db';
import { patternDefinitions } from '../db/schema';

await db.insert(patternDefinitions).values({
  id: 'IMP-001',
  category: 'IMP',
  title: 'LOCF Imputation',
  problem: 'Need to carry forward last observation for missing values',
  whenToUse: 'When you have longitudinal data with intermittent missing values'
});
```

---

## Troubleshooting

### Issue: `vercel: command not found`

**Solution:**
```bash
npm install -g vercel
```

### Issue: "No existing credentials found"

**Solution:**
```bash
vercel login
vercel link
vercel env pull .env.local
```

### Issue: "Cannot find module 'C:\Users\name\My'"

**Problem**: Your project path contains spaces.

**Solution**: Move project to a path without spaces:
```powershell
Move-Item "C:\path\with spaces\sp-skill" "C:\Users\yourname\Documents\sp-skill"
cd C:\Users\yourname\Documents\sp-skill
```

### Issue: API returns raw JavaScript code (not JSON)

**Problem**: Only Vite server is running, not Vercel dev server.

**Solution**: You need **both** servers running:
- Terminal 1: `npm run dev` (Vite on port 3000)
- Terminal 2: `npm run dev:api` (Vercel on port 3001)

### Issue: "Database connection failed"

**Solutions:**

1. **Check environment variables exist:**
   ```bash
   # Windows PowerShell
   Get-Content .env.local | Select-String "POSTGRES"

   # macOS/Linux
   cat .env.local | grep POSTGRES
   ```

2. **Re-pull credentials:**
   ```bash
   vercel env pull .env.local
   ```

3. **Verify database exists** in Vercel Dashboard:
   - https://vercel.com/dashboard ‚Üí sp-skill ‚Üí Storage
   - Your database should be listed

4. **Restart API server** (Terminal 2):
   ```bash
   # Ctrl+C to stop
   npm run dev:api
   ```

### Issue: "MIGRATION_TOKEN not configured"

**Problem**: Environment variable not loaded by API server.

**Solution**: Restart Terminal 2 after adding `MIGRATION_TOKEN` to `.env.local`:
```bash
# Ctrl+C to stop
npm run dev:api
```

### Issue: Port 3000 or 3001 already in use

**Windows:**
```powershell
# Find process using port 3000
netstat -ano | findstr :3000

# Kill process (replace <PID> with actual number)
taskkill /PID <PID> /F
```

**macOS/Linux:**
```bash
# Find and kill process
lsof -ti:3000 | xargs kill -9
```

---

## Security Best Practices

‚úÖ **DO**:
- Keep `.env.local` in `.gitignore`
- Use `POSTGRES_URL` (with pooling) for serverless functions
- Use parameterized queries to prevent SQL injection
- Protect migration endpoint with `MIGRATION_TOKEN`
- Store `MIGRATION_TOKEN` in environment variables, not in code

‚ùå **DON'T**:
- Expose database credentials in client-side code (`index.tsx`)
- Commit `.env.local` to git
- Use string interpolation in SQL queries (SQL injection risk)
- Leave migration endpoint unprotected in production
- Share your `.env.local` file

---

## Next Steps

Now that your database is set up, you can:

1. ‚úÖ **Database connected and verified**
2. ‚úÖ **Migration completed (3 tables created)**
3. üî≤ **Seed pattern data** - Populate `pattern_definitions` with 172 patterns
4. üî≤ **Build CRUD APIs** - Create endpoints for pattern operations
5. üî≤ **Update frontend** - Replace `localStorage` with database API calls
6. üî≤ **Add authentication** - User registration and login

---

## Summary of What We Accomplished

‚úÖ **Infrastructure Setup (Completed)**
- Vercel Postgres database created (free tier)
- Local development environment configured (two-server setup)
- Database schema designed and migrated
- 3 tables created: users, pattern_definitions, pattern_implementations
- Connection verified and tested
- Helper endpoints created (db-test, list-tables, migrate)

**Total time**: ~30 minutes
**Cost**: $0 (free tier)
**Storage**: 0.5 GB available
**Compute**: 100 hours/month available

---

## Resources

- [Vercel Postgres Docs](https://vercel.com/docs/storage/vercel-postgres)
- [Neon Documentation](https://neon.tech/docs)
- [Drizzle ORM Docs](https://orm.drizzle.team/)
- [Vercel CLI Docs](https://vercel.com/docs/cli)
- [DEVELOPMENT.md](./DEVELOPMENT.md) - Complete development workflow guide
